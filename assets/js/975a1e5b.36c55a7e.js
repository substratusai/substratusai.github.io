"use strict";(self.webpackChunksubstratus_website=self.webpackChunksubstratus_website||[]).push([[5777],{76:(t,e,a)=>{a.r(e),a.d(e,{assets:()=>c,contentTitle:()=>r,default:()=>u,frontMatter:()=>l,metadata:()=>o,toc:()=>d});var s=a(5893),n=a(1151),i=a(2719);const l={slug:"k8s-yaml-dataset",title:"The K8s YAML dataset",authors:[{name:"Sam Stoelinga",title:"Engineer",url:"https://github.com/samos123"}],tags:["k8s","yaml","dataset"],image:"/img/the-stack-yaml-k8s-banner.png"},r=void 0,o={permalink:"/blog/k8s-yaml-dataset",editUrl:"https://github.com/substratusai/substratusai.github.io/tree/main/blog/2023-10-09-k8s-yaml-dataset.md",source:"@site/blog/2023-10-09-k8s-yaml-dataset.md",title:"The K8s YAML dataset",description:"Excited to announce the K8s YAML dataset containing",date:"2023-10-09T00:00:00.000Z",formattedDate:"October 9, 2023",tags:[{label:"k8s",permalink:"/blog/tags/k-8-s"},{label:"yaml",permalink:"/blog/tags/yaml"},{label:"dataset",permalink:"/blog/tags/dataset"}],readingTime:2.235,hasTruncateMarker:!1,authors:[{name:"Sam Stoelinga",title:"Engineer",url:"https://github.com/samos123"}],frontMatter:{slug:"k8s-yaml-dataset",title:"The K8s YAML dataset",authors:[{name:"Sam Stoelinga",title:"Engineer",url:"https://github.com/samos123"}],tags:["k8s","yaml","dataset"],image:"/img/the-stack-yaml-k8s-banner.png"},unlisted:!1,prevItem:{title:"Deploying Mistral 7B Instruct on K8s using TGI",permalink:"/blog/mistral-7b-instruct-k8s-helm-tgi"},nextItem:{title:"Tutorial: K8s Kind with GPUs",permalink:"/blog/kind-with-gpus"}},c={authorsImageUrls:[void 0]},d=[{value:"Why?",id:"why",level:2},{value:"How?",id:"how",level:2},{value:"What&#39;s next?",id:"whats-next",level:2}];function h(t){const e={a:"a",br:"br",code:"code",h2:"h2",li:"li",p:"p",pre:"pre",ul:"ul",...(0,n.a)(),...t.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)("img",{src:"/img/the-stack-yaml-k8s-banner.png",alt:"kubectl notebook",width:"100%"}),"\n",(0,s.jsx)(e.p,{children:"Excited to announce the K8s YAML dataset containing\n276,520 valid K8s YAML files."}),"\n",(0,s.jsxs)(e.p,{children:["HuggingFace Dataset: ",(0,s.jsx)(e.a,{href:"https://huggingface.co/datasets/substratusai/the-stack-yaml-k8s",children:"https://huggingface.co/datasets/substratusai/the-stack-yaml-k8s"}),(0,s.jsx)(e.br,{}),"\n","Source code: ",(0,s.jsx)(e.a,{href:"https://github.com/substratusai/the-stack-yaml-k8s",children:"https://github.com/substratusai/the-stack-yaml-k8s"})]}),"\n",(0,s.jsx)(e.h2,{id:"why",children:"Why?"}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"This dataset can be used to fine-tune an LLM directly"}),"\n",(0,s.jsx)(e.li,{children:"New datasets can be created from his dataset such as an K8s instruct dataset (coming soon!)"}),"\n",(0,s.jsx)(e.li,{children:"What's your use case?"}),"\n"]}),"\n",(0,s.jsx)(e.h2,{id:"how",children:"How?"}),"\n",(0,s.jsx)(e.p,{children:"Getting a lot of K8s YAML manifests wasn't easy. My initial approach\nwas to use the Kubernetes website and scrape the YAML example files,\nhowever the issue was the quantity since I could only scrape\nabout ~250 YAML examples that way."}),"\n",(0,s.jsxs)(e.p,{children:["Luckily, I came across ",(0,s.jsx)(e.a,{href:"https://huggingface.co/datasets/bigcode/the-stack",children:"the-stack"})," dataset\nwhich is a cleaned dataset of code on GitHub. The dataset is nicely structured by language\nand I noticed that ",(0,s.jsx)(e.code,{children:"yaml"})," was one of the languages in the dataset."]}),"\n",(0,s.jsx)(e.p,{children:"Install libraries used in this blog post:"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-bash",children:"pip3 install datasets kubernetes-validate\n"})}),"\n",(0,s.jsxs)(e.p,{children:["Let's load the ",(0,s.jsx)(e.code,{children:"the-stack"})," dataset but only the YAML files (takes about 200GB of disk space):"]}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-python",children:'from datasets import load_dataset\nds = load_dataset("bigcode/the-stack", data_dir="data/yaml", split="train")\n'})}),"\n",(0,s.jsxs)(e.p,{children:["Once loaded there are 13,439,939 YAML files in ",(0,s.jsx)(e.code,{children:"ds"}),"."]}),"\n",(0,s.jsx)(e.p,{children:"You can check the content of one of the files:"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-python",children:'print(ds[0]["content"])\n'})}),"\n",(0,s.jsx)(e.p,{children:"You probably notice that this ain't a K8s YAML file, so next we need to filter\nthese 13 million YAML files and only keep the one that have valid K8 YAML."}),"\n",(0,s.jsxs)(e.p,{children:["The approach I took was to use the ",(0,s.jsx)(e.a,{href:"https://github.com/willthames/kubernetes-validate",children:"kubernetes-validate"}),' OSS library. It turned out\nthat YAML parsing was too slow so I added a 10x speed improvement\nby eagerly checking if "Kind or "kind" is not a substring in the YAML file.']}),"\n",(0,s.jsx)(e.p,{children:"Here is the validate function that takes the yaml_content as a string and\nreturns if the content was valid K8s YAML or not:"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-python",children:'import kubernetes_validate\nimport yaml\n\ndef validate(yaml_content: str):\n    try:\n        # Speed optimization to return early without having to load YAML\n        if "kind" not in yaml_content and "Kind" not in yaml_content:\n            return False\n        data = yaml.safe_load(yaml_content)\n        kubernetes_validate.validate(data, \'1.22\', strict=True)\n        return True\n    except Exception as e:\n        return False\n\nvalidate(ds[0]["content"])\n'})}),"\n",(0,s.jsx)(e.p,{children:"Now all that's needed is to filter out all YAML files that aren't valid:"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-python",children:'import os\nos.cpu_count()\nvalid_k8s = ds.filter(lambda batch: [validate(x) for x in batch["content"]],\n                      num_proc=os.cpu_count(), batched=True)\n'})}),"\n",(0,s.jsxs)(e.p,{children:["There were 276,520 YAML files left in ",(0,s.jsx)(e.code,{children:"valid_k8s"}),". You can print one again to see:"]}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-python",children:'print(valid_k8s[0]["content"])\n'})}),"\n",(0,s.jsx)(e.p,{children:"You can upload the dataset back to HuggingFace by running:"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-python",children:'valid_k8s.push_to_hub("substratusai/the-stack-yaml-k8s")\n'})}),"\n",(0,s.jsx)(e.h2,{id:"whats-next",children:"What's next?"}),"\n",(0,s.jsx)(e.p,{children:"Creating a new dataset called K8s Instruct that also provides a prompt for each YAML file."}),"\n",(0,s.jsxs)(e.p,{children:["Support the project by adding a star on GitHub! \u2764\ufe0f\n",(0,s.jsx)(i.Z,{href:"https://github.com/substratusai/substratus","data-icon":"octicon-star","data-size":"large","data-show-count":"true","aria-label":"Star substratusai/substratus on GitHub",children:"Star"})]})]})}function u(t={}){const{wrapper:e}={...(0,n.a)(),...t.components};return e?(0,s.jsx)(e,{...t,children:(0,s.jsx)(h,{...t})}):h(t)}},1151:(t,e,a)=>{a.d(e,{Z:()=>r,a:()=>l});var s=a(7294);const n={},i=s.createContext(n);function l(t){const e=s.useContext(i);return s.useMemo((function(){return"function"==typeof t?t(e):{...e,...t}}),[e,t])}function r(t){let e;return e=t.disableParentContext?"function"==typeof t.components?t.components(n):t.components||n:l(t.components),s.createElement(i.Provider,{value:e},t.children)}}}]);