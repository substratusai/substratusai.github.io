"use strict";(self.webpackChunksubstratus_website=self.webpackChunksubstratus_website||[]).push([[7629],{3905:(e,t,n)=>{n.d(t,{Zo:()=>p,kt:()=>h});var a=n(7294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function s(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function o(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},i=Object.keys(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var l=a.createContext({}),u=function(e){var t=a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):s(s({},t),e)),n},p=function(e){var t=u(e.components);return a.createElement(l.Provider,{value:t},e.children)},c="mdxType",m={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},d=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,i=e.originalType,l=e.parentName,p=o(e,["components","mdxType","originalType","parentName"]),c=u(n),d=r,h=c["".concat(l,".").concat(d)]||c[d]||m[d]||i;return n?a.createElement(h,s(s({ref:t},p),{},{components:n})):a.createElement(h,s({ref:t},p))}));function h(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var i=n.length,s=new Array(i);s[0]=d;var o={};for(var l in t)hasOwnProperty.call(t,l)&&(o[l]=t[l]);o.originalType=e,o[c]="string"==typeof e?e:r,s[1]=o;for(var u=2;u<i;u++)s[u]=n[u];return a.createElement.apply(null,s)}return a.createElement.apply(null,n)}d.displayName="MDXCreateElement"},5518:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>s,default:()=>m,frontMatter:()=>i,metadata:()=>o,toc:()=>u});var a=n(7462),r=(n(7294),n(3905));const i={slug:"mistral-7b-instruct-k8s-helm-tgi",title:"Deploying Mistral 7B Instruct on K8s using TGI",authors:[{name:"Sam Stoelinga",title:"Engineer",url:"https://github.com/samos123"}],tags:["k8s","mistral-7b","helm"],image:"/img/mistral-7b-helm-k8s-tgi.png"},s=void 0,o={permalink:"/blog/mistral-7b-instruct-k8s-helm-tgi",editUrl:"https://github.com/substratusai/substratusai.github.io/tree/main/blog/2023-10-21-mistral-7b-instruct-k8s-tgi.md",source:"@site/blog/2023-10-21-mistral-7b-instruct-k8s-tgi.md",title:"Deploying Mistral 7B Instruct on K8s using TGI",description:"Learn how to use the text-generation-inference (TGI) Helm Chart to quickly",date:"2023-10-21T00:00:00.000Z",formattedDate:"October 21, 2023",tags:[{label:"k8s",permalink:"/blog/tags/k-8-s"},{label:"mistral-7b",permalink:"/blog/tags/mistral-7-b"},{label:"helm",permalink:"/blog/tags/helm"}],readingTime:2.91,hasTruncateMarker:!1,authors:[{name:"Sam Stoelinga",title:"Engineer",url:"https://github.com/samos123"}],frontMatter:{slug:"mistral-7b-instruct-k8s-helm-tgi",title:"Deploying Mistral 7B Instruct on K8s using TGI",authors:[{name:"Sam Stoelinga",title:"Engineer",url:"https://github.com/samos123"}],tags:["k8s","mistral-7b","helm"],image:"/img/mistral-7b-helm-k8s-tgi.png"},nextItem:{title:"The K8s YAML dataset",permalink:"/blog/k8s-yaml-dataset"}},l={authorsImageUrls:[void 0]},u=[],p={toc:u},c="wrapper";function m(e){let{components:t,...n}=e;return(0,r.kt)(c,(0,a.Z)({},p,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("img",{src:"/img/mistral-7b-helm-k8s-tgi.png",alt:"mistral 7b k8s helm",width:"100%"}),(0,r.kt)("p",null,"Learn how to use the text-generation-inference (TGI) Helm Chart to quickly\ndeploy Mistral 7B Instruct on your K8s cluster."),(0,r.kt)("p",null,"Add the Substratus.ai Helm repo:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"helm repo add substratusai https://substratusai.github.io/helm\n")),(0,r.kt)("p",null,"This command adds a new Helm repository, making the ",(0,r.kt)("inlineCode",{parentName:"p"},"text-generation-inference"),"\nHelm chart available for installation."),(0,r.kt)("p",null,"Create a configuration file named ",(0,r.kt)("inlineCode",{parentName:"p"},"values.yaml"),". This file will contain the necessary settings for your deployment. Here\u2019s an example of what the content should look like:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"model: mistralai/Mistral-7B-Instruct-v0.1\n# resources: # optional, override if you need more than 1 GPU\n#   limits:\n#     nvidia.com/gpu: 1\n# nodeSelector: # optional, can be used to target specific GPUs\n#   cloud.google.com/gke-accelerator: nvidia-l4\n")),(0,r.kt)("p",null,"In this configuration file, you are specifying the model to be deployed and optionally setting resource limits or targeting specific nodes based on your requirements."),(0,r.kt)("p",null,"With your configuration file ready, you can now deploy Mistral 7B Instruct using Helm:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"helm install mistral-7b-instruct substratusai/text-generation-inference \\\n    -f values.yaml\n")),(0,r.kt)("p",null,"This command initiates the deployment, creating a Kubernetes Deployment and Service based on the settings defined in your ",(0,r.kt)("inlineCode",{parentName:"p"},"values.yaml")," file."),(0,r.kt)("p",null,"After initiating the deployment, it's important to ensure that everything is running as expected. Run the following command to get detailed information about the newly created pod:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"kubectl describe pod -l app.kubernetes.io/instance=mistral-7b-instruct\n")),(0,r.kt)("p",null,"This will display various details about the pod, helping you to confirm that it has been successfully created and is in the right state. Note that depending on your cluster's setup, you might need to wait for the cluster autoscaler to provision additional resources if necessary."),(0,r.kt)("p",null,"Once the pod is running, check the logs to ensure that the model is initializing properly:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"kubectl logs -f -l app.kubernetes.io/instance=mistral-7b-instruct\n")),(0,r.kt)("p",null,"The model first downloads the model and after a few minutes, you should\nsee a message that looks like this:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-text"},"Invalid hostname, defaulting to 0.0.0.0\n")),(0,r.kt)("p",null,"This is expected and means it's now serving on host 0.0.0.0."),(0,r.kt)("p",null,"By default, the model is only accessible within the Kubernetes cluster. To access it from your local machine, set up a port forward:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"kubectl port-forward deployments/mistral-7b-instruct-text-generation-inference 8080:8080\n")),(0,r.kt)("p",null,"This command maps port 8080 on your local machine to port 8080 on the deployed pod, allowing you to interact with the model directly."),(0,r.kt)("p",null,"With the service exposed, you can now run inference tasks. To explore the available API endpoints and their usage, visit the TGI API documentation at ",(0,r.kt)("a",{parentName:"p",href:"http://localhost:8080/docs"},"http://localhost:8080/docs"),"."),(0,r.kt)("p",null,"Here\u2019s an example of how to use curl to run an inference task:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},'curl 127.0.0.1:8080/generate -X POST \\\n    -H \'Content-Type: application/json\' \\\n    --data-binary @- << \'EOF\' | jq -r \'.generated_text\'\n{\n    "inputs": "<s>[INST] Write a K8s YAML file to create a pod that deploys nginx[/INST]",\n    "parameters": {"max_new_tokens": 400}\n}\nEOF\n')),(0,r.kt)("p",null,"In this example, we are instructing the model to generate a Kubernetes YAML file for deploying an Nginx pod. The prompt includes specific tokens that the Mistral 7B Instruct model recognizes, ensuring accurate and context-aware responses."),(0,r.kt)("p",null,"The prompt we are using starts with ",(0,r.kt)("inlineCode",{parentName:"p"},"<s>")," token which indicates beginning of a sequence.\nThe ",(0,r.kt)("inlineCode",{parentName:"p"},"[INST]")," token tells Mistral-7b Instruct what follows is an instruction. The Mistral 7B\nInstruct model was finetuned with this prompt template, so it's important to re-use that\nsame prompt template."),(0,r.kt)("p",null,"The response is quite impressive, it did return a valid K8s YAML manifest\nand also instructions on how to apply it."),(0,r.kt)("p",null,"Need help? Want to see other models? other serving frameworks?",(0,r.kt)("br",{parentName:"p"}),"\n","Join our Discord and ask me directly:  "),(0,r.kt)("a",{href:"https://discord.gg/JeXhcmjZVm"},(0,r.kt)("img",{alt:"discord-invite",src:"https://dcbadge.vercel.app/api/server/JeXhcmjZVm?style=flat"})))}m.isMDXComponent=!0}}]);