"use strict";(self.webpackChunksubstratus_website=self.webpackChunksubstratus_website||[]).push([[6885],{6620:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>d,contentTitle:()=>o,default:()=>u,frontMatter:()=>s,metadata:()=>r,toc:()=>l});var i=t(5893),a=t(1151);const s={slug:"kind-with-gpus",title:"Tutorial: K8s Kind with GPUs",authors:[{name:"Sam Stoelinga",title:"Engineer",url:"https://github.com/samos123"}],tags:["kind","gpu"]},o=void 0,r={permalink:"/blog/kind-with-gpus",editUrl:"https://github.com/substratusai/substratusai.github.io/tree/main/blog/2023-09-07-kind-with-gpus.md",source:"@site/blog/2023-09-07-kind-with-gpus.md",title:"Tutorial: K8s Kind with GPUs",description:"Don't you just love it when you submit a PR and it turns out that no code is",date:"2023-09-07T00:00:00.000Z",formattedDate:"September 7, 2023",tags:[{label:"kind",permalink:"/blog/tags/kind"},{label:"gpu",permalink:"/blog/tags/gpu"}],readingTime:1.33,hasTruncateMarker:!1,authors:[{name:"Sam Stoelinga",title:"Engineer",url:"https://github.com/samos123"}],frontMatter:{slug:"kind-with-gpus",title:"Tutorial: K8s Kind with GPUs",authors:[{name:"Sam Stoelinga",title:"Engineer",url:"https://github.com/samos123"}],tags:["kind","gpu"]},unlisted:!1,prevItem:{title:"The K8s YAML dataset",permalink:"/blog/k8s-yaml-dataset"},nextItem:{title:"Converting HuggingFace Models to GGUF/GGML",permalink:"/blog/converting-hf-model-gguf-model"}},d={authorsImageUrls:[void 0]},l=[];function c(e){const n={a:"a",code:"code",p:"p",pre:"pre",...(0,a.a)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)("div",{class:"video-container",children:(0,i.jsx)("iframe",{class:"video",src:"https://www.youtube-nocookie.com/embed/O1683vzaJVE",title:"YouTube video player",frameborder:"0",allow:"accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share",allowfullscreen:!0})}),"\n",(0,i.jsx)(n.p,{children:"Don't you just love it when you submit a PR and it turns out that no code is\nneeded? That's exactly what happened when I tried add GPU support to Kind."}),"\n",(0,i.jsxs)(n.p,{children:["In this blog post you will learn how to configure Kind such\nthat it can use the GPUs on your device. Credit to\n",(0,i.jsx)(n.a,{href:"https://github.com/kubernetes-sigs/kind/pull/3257#issuecomment-1607287275",children:"@klueska"}),"\nfor the solution."]}),"\n",(0,i.jsxs)(n.p,{children:["Install the NVIDIA container toolkit by following the ",(0,i.jsx)(n.a,{href:"https://docs.nvidia.com/datacenter/cloud-native/container-toolkit/latest/user-guide.html#adding-the-nvidia-runtime",children:"official install docs"}),"."]}),"\n",(0,i.jsx)(n.p,{children:"Configure NVIDIA to be the default runtime for docker:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"sudo nvidia-ctk runtime configure --runtime=docker --set-as-default\nsudo systemctl restart docker\n"})}),"\n",(0,i.jsxs)(n.p,{children:["Set ",(0,i.jsx)(n.code,{children:"accept-nvidia-visible-devices-as-volume-mounts = true"})," in ",(0,i.jsx)(n.code,{children:"/etc/nvidia-container-runtime/config.toml"}),":"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"sudo sed -i '/accept-nvidia-visible-devices-as-volume-mounts/c\\accept-nvidia-visible-devices-as-volume-mounts = true' /etc/nvidia-container-runtime/config.toml\n"})}),"\n",(0,i.jsx)(n.p,{children:"Create a Kind Cluster:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"kind create cluster --name substratus --config - <<EOF\napiVersion: kind.x-k8s.io/v1alpha4\nkind: Cluster\nnodes:\n- role: control-plane\n  image: kindest/node:v1.27.3@sha256:3966ac761ae0136263ffdb6cfd4db23ef8a83cba8a463690e98317add2c9ba72\n  # required for GPU workaround\n  extraMounts:\n    - hostPath: /dev/null\n      containerPath: /var/run/nvidia-container-devices/all\nEOF\n"})}),"\n",(0,i.jsxs)(n.p,{children:["Workaround for issue with missing required file ",(0,i.jsx)(n.code,{children:"/sbin/ldconfig.real"}),":"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"# https://github.com/NVIDIA/nvidia-docker/issues/614#issuecomment-423991632\ndocker exec -ti substratus-control-plane ln -s /sbin/ldconfig /sbin/ldconfig.real\n"})}),"\n",(0,i.jsx)(n.p,{children:"Install the K8s NVIDIA GPU operator so K8s is aware of your NVIDIA device:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"helm repo add nvidia https://helm.ngc.nvidia.com/nvidia || true\nhelm repo update\nhelm install --wait --generate-name \\\n     -n gpu-operator --create-namespace \\\n     nvidia/gpu-operator --set driver.enabled=false\n"})}),"\n",(0,i.jsx)(n.p,{children:"You should now have a working Kind cluster that can access your GPU.\nVerify it by running a simple pod:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:'kubectl apply -f - << EOF\napiVersion: v1\nkind: Pod\nmetadata:\n  name: cuda-vectoradd\nspec:\n  restartPolicy: OnFailure\n  containers:\n  - name: cuda-vectoradd\n    image: "nvcr.io/nvidia/k8s/cuda-sample:vectoradd-cuda11.7.1-ubuntu20.04"\n    resources:\n      limits:\n        nvidia.com/gpu: 1\nEOF\n'})})]})}function u(e={}){const{wrapper:n}={...(0,a.a)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(c,{...e})}):c(e)}},1151:(e,n,t)=>{t.d(n,{Z:()=>r,a:()=>o});var i=t(7294);const a={},s=i.createContext(a);function o(e){const n=i.useContext(s);return i.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function r(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:o(e.components),i.createElement(s.Provider,{value:n},e.children)}}}]);