"use strict";(self.webpackChunksubstratus_website=self.webpackChunksubstratus_website||[]).push([[4760],{7503:(e,s,t)=>{t.r(s),t.d(s,{assets:()=>o,contentTitle:()=>i,default:()=>d,frontMatter:()=>r,metadata:()=>c,toc:()=>u});var n=t(5893),a=t(1151);const r={sidebar_position:4},i="GCP - Google Cloud",c={id:"installation/gcp",title:"GCP - Google Cloud",description:"Subsratus required resources",source:"@site/docs/installation/gcp.md",sourceDirName:"installation",slug:"/installation/gcp",permalink:"/docs/installation/gcp",draft:!1,unlisted:!1,editUrl:"https://github.com/substratusai/substratusai.github.io/tree/main/docs/installation/gcp.md",tags:[],version:"current",sidebarPosition:4,frontMatter:{sidebar_position:4},sidebar:"tutorialSidebar",previous:{title:"Installation",permalink:"/docs/installation/"},next:{title:"Notebooks",permalink:"/docs/notebooks"}},o={},u=[{value:"Subsratus required resources",id:"subsratus-required-resources",level:2},{value:"Basic",id:"basic",level:2},{value:"Install",id:"install",level:4},{value:"Cleanup",id:"cleanup",level:4},{value:"Custom",id:"custom",level:2},{value:"Configure environment variables",id:"configure-environment-variables",level:3},{value:"1. (Optional) Create or re-use existing GKE cluster",id:"1-optional-create-or-re-use-existing-gke-cluster",level:3},{value:"2. Create or reuse existing GCS bucket",id:"2-create-or-reuse-existing-gcs-bucket",level:3},{value:"3. Create or reuse existing Google Artifact Registry",id:"3-create-or-reuse-existing-google-artifact-registry",level:3},{value:"4. Create or reuse an existing GCP Service Account",id:"4-create-or-reuse-an-existing-gcp-service-account",level:3},{value:"5. Assign the permissions needed to the GCP Service Account",id:"5-assign-the-permissions-needed-to-the-gcp-service-account",level:3},{value:"6. Deploy and configure Substratus operator",id:"6-deploy-and-configure-substratus-operator",level:3}];function l(e){const s={a:"a",code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",h4:"h4",li:"li",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,a.a)(),...e.components};return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(s.h1,{id:"gcp---google-cloud",children:"GCP - Google Cloud"}),"\n",(0,n.jsx)(s.h2,{id:"subsratus-required-resources",children:"Subsratus required resources"}),"\n",(0,n.jsxs)(s.ul,{children:["\n",(0,n.jsx)(s.li,{children:"GKE Cluster with GCSFuse and Workload Identity"}),"\n",(0,n.jsx)(s.li,{children:"GCS Bucket to store Model and Dataset data"}),"\n",(0,n.jsx)(s.li,{children:"Google Artifact Registry Container Repository to store newly built container images"}),"\n",(0,n.jsxs)(s.li,{children:["Google Service Account for:","\n",(0,n.jsxs)(s.ul,{children:["\n",(0,n.jsx)(s.li,{children:"read/write access to GCS Bucket"}),"\n",(0,n.jsx)(s.li,{children:"read/write access to to Artifact Registry"}),"\n",(0,n.jsx)(s.li,{children:"setIamPolicy on Google ServiceAccount for managing cross namespace Workload Identity bindings"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,n.jsx)(s.h2,{id:"basic",children:"Basic"}),"\n",(0,n.jsx)(s.p,{children:"A basic automatic installer creates everything you would need in an empty GCP project.\nIt automatically creates the GKE cluster, GCS bucket, Artifact Registry and Service Account.\nThe script also ensures all required permissions are given to the Service Account."}),"\n",(0,n.jsx)(s.p,{children:"This installation method is only intended to work in a basic GCP project free of any significant constraints (i.e. GCP Organizational Policies, etc)."}),"\n",(0,n.jsx)(s.h4,{id:"install",children:"Install"}),"\n",(0,n.jsx)(s.p,{children:"Run the automatic installer:"}),"\n",(0,n.jsx)(s.pre,{children:(0,n.jsx)(s.code,{className:"language-bash",children:"export PROJECT_ID=$(gcloud config get project)\nbash <(curl https://raw.githubusercontent.com/substratusai/substratus/main/install/gcp/up.sh)\n"})}),"\n",(0,n.jsx)(s.h4,{id:"cleanup",children:"Cleanup"}),"\n",(0,n.jsx)(s.p,{children:"Clean up deletes all the resources that are created in the script. This could\ndestroy valuable data and resources."}),"\n",(0,n.jsx)(s.p,{children:"Run the clean up script to delete all resources created by the automatic installer:"}),"\n",(0,n.jsx)(s.pre,{children:(0,n.jsx)(s.code,{className:"language-bash",children:"export PROJECT_ID=$(gcloud config get project)\nbash <(curl https://raw.githubusercontent.com/substratusai/substratus/main/install/gcp/down.sh)\n"})}),"\n",(0,n.jsx)(s.h2,{id:"custom",children:"Custom"}),"\n",(0,n.jsx)(s.p,{children:"The customizable step by step install lets you use your existing resources (e.g. GKE cluster, bucket and GAR) and other resources instead\nof having Substratus automatically do everything for you. Users in restricted environments\nor who need to re-use existing resources are encouraged to use the advanced install."}),"\n",(0,n.jsx)(s.p,{children:"You will be going through the following steps:"}),"\n",(0,n.jsxs)(s.ol,{children:["\n",(0,n.jsx)(s.li,{children:"Create or reuse a K8s cluster and configure it according to needs of Substratus"}),"\n",(0,n.jsx)(s.li,{children:"Create or reuse an existing Cloud Bucket"}),"\n",(0,n.jsx)(s.li,{children:"Create or reuse an existing Container Image Registry"}),"\n",(0,n.jsx)(s.li,{children:"Create or reuse an existing GCP Service Account"}),"\n",(0,n.jsx)(s.li,{children:"Assign the permissions needed to the GCP Service Account"}),"\n",(0,n.jsx)(s.li,{children:"Deploy and configure the Substratus operator"}),"\n"]}),"\n",(0,n.jsx)(s.h3,{id:"configure-environment-variables",children:"Configure environment variables"}),"\n",(0,n.jsx)(s.p,{children:"Lets configure a few basic environment variables that will be used throughout\nthe various steps:"}),"\n",(0,n.jsx)(s.pre,{children:(0,n.jsx)(s.code,{className:"language-sh",children:"export PROJECT_ID=$(gcloud config get project)\nexport REGION=us-central1\nexport ZONE=us-central1-a\n"})}),"\n",(0,n.jsx)(s.h3,{id:"1-optional-create-or-re-use-existing-gke-cluster",children:"1. (Optional) Create or re-use existing GKE cluster"}),"\n",(0,n.jsx)(s.p,{children:"Substratus has the following requirements for a GKE cluster:"}),"\n",(0,n.jsxs)(s.ul,{children:["\n",(0,n.jsx)(s.li,{children:"GCSfuse addon is enabled"}),"\n",(0,n.jsx)(s.li,{children:"Workload Identity is enabled"}),"\n",(0,n.jsx)(s.li,{children:"(optional) Ability to utilize GPU nodes"}),"\n"]}),"\n",(0,n.jsx)(s.p,{children:"You can skip this step if you already have a cluster that meets those requirements."}),"\n",(0,n.jsxs)(s.p,{children:["Set the name of your cluster:\n",(0,n.jsx)(s.a,{href:"#",title:"https://raw.githubusercontent.com/substratusai/substratus/main/install/gcp/up.sh bash /gcloud storage buckets add-iam-policy-binding/ /svc.id.goog[substratus/sci].*$/",children:"embedmd"}),":# (",(0,n.jsx)(s.a,{href:"https://raw.githubusercontent.com/substratusai/substratus/main/install/gcp/up.sh",children:"https://raw.githubusercontent.com/substratusai/substratus/main/install/gcp/up.sh"})," bash /export CLUSTER_NAME/ /$/)"]}),"\n",(0,n.jsx)(s.pre,{children:(0,n.jsx)(s.code,{className:"language-bash",children:"export CLUSTER_NAME=substratus\n"})}),"\n",(0,n.jsxs)(s.p,{children:["Create a new GKE cluster using gcloud:\n",(0,n.jsx)(s.a,{href:"#",title:"https://raw.githubusercontent.com/substratusai/substratus/main/install/gcp/up.sh bash /gcloud storage buckets add-iam-policy-binding/ /svc.id.goog[substratus/sci].*$/",children:"embedmd"}),":# (",(0,n.jsx)(s.a,{href:"https://raw.githubusercontent.com/substratusai/substratus/main/install/gcp/up.sh",children:"https://raw.githubusercontent.com/substratusai/substratus/main/install/gcp/up.sh"})," bash /gcloud container clusters create/ /--addons GcsFuseCsiDriver/)"]}),"\n",(0,n.jsx)(s.pre,{children:(0,n.jsx)(s.code,{className:"language-bash",children:"gcloud container clusters create ${CLUSTER_NAME} --location ${REGION} \\\n  --machine-type n2d-standard-8 --num-nodes 1 --min-nodes 1 --max-nodes 5 \\\n  --node-locations ${ZONE} --workload-pool ${PROJECT_ID}.svc.id.goog \\\n  --enable-image-streaming --enable-shielded-nodes --shielded-secure-boot \\\n  --shielded-integrity-monitoring --enable-autoprovisioning \\\n  --max-cpu 960 --max-memory 9600 --ephemeral-storage-local-ssd=count=2 \\\n  --autoprovisioning-scopes=logging.write,monitoring,devstorage.read_only,compute \\\n  --addons GcsFuseCsiDriver\n"})}),"\n",(0,n.jsxs)(s.p,{children:["Create new GPU nodepools (e.g. L4 GPU nodepools):\n",(0,n.jsx)(s.a,{href:"#",title:"https://raw.githubusercontent.com/substratusai/substratus/main/install/gcp/up.sh bash /gcloud storage buckets add-iam-policy-binding/ /svc.id.goog[substratus/sci].*$/",children:"embedmd"}),":# (",(0,n.jsx)(s.a,{href:"https://raw.githubusercontent.com/substratusai/substratus/main/install/gcp/up.sh",children:"https://raw.githubusercontent.com/substratusai/substratus/main/install/gcp/up.sh"})," bash /^nodepool_args=/ /machine-type g2-standard-48.",(0,n.jsx)(s.em,{children:"\\n."}),"/)"]}),"\n",(0,n.jsx)(s.pre,{children:(0,n.jsx)(s.code,{className:"language-bash",children:'nodepool_args=(--spot --enable-autoscaling --enable-image-streaming\n  --num-nodes=0 --min-nodes=0 --max-nodes=3 --cluster ${CLUSTER_NAME}\n  --node-locations ${REGION}-a,${REGION}-b --region ${REGION} --async)\n\ngcloud container node-pools create g2-standard-8 \\\n  --accelerator type=nvidia-l4,count=1,gpu-driver-version=latest \\\n  --machine-type g2-standard-8 --ephemeral-storage-local-ssd=count=1 \\\n  "${nodepool_args[@]}"\n\ngcloud container node-pools create g2-standard-24 \\\n  --accelerator type=nvidia-l4,count=2,gpu-driver-version=latest \\\n  --machine-type g2-standard-24 --ephemeral-storage-local-ssd=count=2 \\\n  "${nodepool_args[@]}"\n\ngcloud container node-pools create g2-standard-48 \\\n  --accelerator type=nvidia-l4,count=4,gpu-driver-version=latest \\\n  --machine-type g2-standard-48 --ephemeral-storage-local-ssd=count=4 \\\n  "${nodepool_args[@]}"\n'})}),"\n",(0,n.jsx)(s.h3,{id:"2-create-or-reuse-existing-gcs-bucket",children:"2. Create or reuse existing GCS bucket"}),"\n",(0,n.jsx)(s.p,{children:"Substratus recommends using a GCS bucket in the same region\nas the GKE cluster. This GCS bucket will be used for storing\nML models and datasets."}),"\n",(0,n.jsxs)(s.p,{children:["Specify the URL of the bucket you wish to use:\n",(0,n.jsx)(s.a,{href:"#",title:"https://raw.githubusercontent.com/substratusai/substratus/main/install/gcp/up.sh bash /gcloud storage buckets add-iam-policy-binding/ /svc.id.goog[substratus/sci].*$/",children:"embedmd"}),":# (",(0,n.jsx)(s.a,{href:"https://raw.githubusercontent.com/substratusai/substratus/main/install/gcp/up.sh",children:"https://raw.githubusercontent.com/substratusai/substratus/main/install/gcp/up.sh"})," bash /^export ARTIFACTS_BUCKET=/ /$/)"]}),"\n",(0,n.jsx)(s.pre,{children:(0,n.jsx)(s.code,{className:"language-bash",children:'export ARTIFACTS_BUCKET="gs://${PROJECT_ID}-substratus-artifacts"\n'})}),"\n",(0,n.jsxs)(s.p,{children:["Create the bucket if needed\n",(0,n.jsx)(s.a,{href:"#",title:"https://raw.githubusercontent.com/substratusai/substratus/main/install/gcp/up.sh bash /gcloud storage buckets add-iam-policy-binding/ /svc.id.goog[substratus/sci].*$/",children:"embedmd"}),":# (",(0,n.jsx)(s.a,{href:"https://raw.githubusercontent.com/substratusai/substratus/main/install/gcp/up.sh",children:"https://raw.githubusercontent.com/substratusai/substratus/main/install/gcp/up.sh"})," bash /^gcloud storage buckets create/ /$/)"]}),"\n",(0,n.jsx)(s.pre,{children:(0,n.jsx)(s.code,{className:"language-bash",children:'gcloud storage buckets create "${ARTIFACTS_BUCKET}" --location ${REGION}\n'})}),"\n",(0,n.jsx)(s.h3,{id:"3-create-or-reuse-existing-google-artifact-registry",children:"3. Create or reuse existing Google Artifact Registry"}),"\n",(0,n.jsx)(s.p,{children:"Substratus uses the Google Artifact Registry to push new images\nand pull images. You can reuse an existing one or create a new one."}),"\n",(0,n.jsxs)(s.p,{children:["Specify the repository you wish to use:\n",(0,n.jsx)(s.a,{href:"#",title:"https://raw.githubusercontent.com/substratusai/substratus/main/install/gcp/up.sh bash /gcloud storage buckets add-iam-policy-binding/ /svc.id.goog[substratus/sci].*$/",children:"embedmd"}),":# (",(0,n.jsx)(s.a,{href:"https://raw.githubusercontent.com/substratusai/substratus/main/install/gcp/up.sh",children:"https://raw.githubusercontent.com/substratusai/substratus/main/install/gcp/up.sh"})," bash /^export GAR_REPO_NAME/ /REGISTRY_URL.*$/)"]}),"\n",(0,n.jsx)(s.pre,{children:(0,n.jsx)(s.code,{className:"language-bash",children:"export GAR_REPO_NAME=substratus\nexport REGISTRY_URL=${REGION}-docker.pkg.dev/${PROJECT_ID}/${GAR_REPO_NAME}\n"})}),"\n",(0,n.jsxs)(s.p,{children:["Create a new GAR repo:\n",(0,n.jsx)(s.a,{href:"#",title:"https://raw.githubusercontent.com/substratusai/substratus/main/install/gcp/up.sh bash /gcloud storage buckets add-iam-policy-binding/ /svc.id.goog[substratus/sci].*$/",children:"embedmd"}),":# (",(0,n.jsx)(s.a,{href:"https://raw.githubusercontent.com/substratusai/substratus/main/install/gcp/up.sh",children:"https://raw.githubusercontent.com/substratusai/substratus/main/install/gcp/up.sh"})," bash /gcloud artifacts repositories create/ /format=docker.*$/)"]}),"\n",(0,n.jsx)(s.pre,{children:(0,n.jsx)(s.code,{className:"language-bash",children:"gcloud artifacts repositories create ${GAR_REPO_NAME} \\\n  --repository-format=docker --location=${REGION}\n"})}),"\n",(0,n.jsx)(s.h3,{id:"4-create-or-reuse-an-existing-gcp-service-account",children:"4. Create or reuse an existing GCP Service Account"}),"\n",(0,n.jsx)(s.p,{children:"Substratus uses a GCP Service Account to authenticate to the GCS Bucket\nthat hosts the Model and Datasets data."}),"\n",(0,n.jsxs)(s.p,{children:["Specify the service account you wish to use:\n",(0,n.jsx)(s.a,{href:"#",title:"https://raw.githubusercontent.com/substratusai/substratus/main/install/gcp/up.sh bash /gcloud storage buckets add-iam-policy-binding/ /svc.id.goog[substratus/sci].*$/",children:"embedmd"}),":# (",(0,n.jsx)(s.a,{href:"https://raw.githubusercontent.com/substratusai/substratus/main/install/gcp/up.sh",children:"https://raw.githubusercontent.com/substratusai/substratus/main/install/gcp/up.sh"})," bash /export SERVICE_ACCOUNT_NAME/ /SERVICE_ACCOUNT=.*$/)"]}),"\n",(0,n.jsx)(s.pre,{children:(0,n.jsx)(s.code,{className:"language-bash",children:'export SERVICE_ACCOUNT_NAME=substratus\nexport SERVICE_ACCOUNT="${SERVICE_ACCOUNT_NAME}@${PROJECT_ID}.iam.gserviceaccount.com"\n'})}),"\n",(0,n.jsxs)(s.p,{children:["Create a new service account:\n",(0,n.jsx)(s.a,{href:"#",title:"https://raw.githubusercontent.com/substratusai/substratus/main/install/gcp/up.sh bash /gcloud storage buckets add-iam-policy-binding/ /svc.id.goog[substratus/sci].*$/",children:"embedmd"}),":# (",(0,n.jsx)(s.a,{href:"https://raw.githubusercontent.com/substratusai/substratus/main/install/gcp/up.sh",children:"https://raw.githubusercontent.com/substratusai/substratus/main/install/gcp/up.sh"})," bash /gcloud iam service-accounts create/ /$/)"]}),"\n",(0,n.jsx)(s.pre,{children:(0,n.jsx)(s.code,{className:"language-bash",children:"gcloud iam service-accounts create ${SERVICE_ACCOUNT_NAME}\n"})}),"\n",(0,n.jsx)(s.h3,{id:"5-assign-the-permissions-needed-to-the-gcp-service-account",children:"5. Assign the permissions needed to the GCP Service Account"}),"\n",(0,n.jsx)(s.pre,{children:(0,n.jsx)(s.code,{className:"language-bash",children:'gcloud storage buckets add-iam-policy-binding ${ARTIFACTS_BUCKET} \\\n  --member="serviceAccount:${SERVICE_ACCOUNT}" --role=roles/storage.admin\n\ngcloud artifacts repositories add-iam-policy-binding substratus \\\n  --location us-central1 --member="serviceAccount:${SERVICE_ACCOUNT}" \\\n  --role=roles/artifactregistry.admin\n\n# Allow the Service Account to bind K8s Service Account to this Service Account\ngcloud iam service-accounts add-iam-policy-binding ${SERVICE_ACCOUNT} \\\n   --role roles/iam.serviceAccountAdmin --member "serviceAccount:${SERVICE_ACCOUNT}"\n\n# Allow to create signed URLs\ngcloud iam service-accounts add-iam-policy-binding ${SERVICE_ACCOUNT} \\\n   --role roles/iam.serviceAccountTokenCreator \\\n   --member "serviceAccount:${SERVICE_ACCOUNT}"\n\ngcloud iam service-accounts add-iam-policy-binding ${SERVICE_ACCOUNT} \\\n   --role roles/iam.workloadIdentityUser \\\n   --member "serviceAccount:${PROJECT_ID}.svc.id.goog[substratus/sci]"\n'})}),"\n",(0,n.jsx)(s.h3,{id:"6-deploy-and-configure-substratus-operator",children:"6. Deploy and configure Substratus operator"}),"\n",(0,n.jsxs)(s.p,{children:["Create the namespace for the operator (needs to be substratus):\n",(0,n.jsx)(s.a,{href:"#",title:"https://raw.githubusercontent.com/substratusai/substratus/main/install/gcp/up.sh bash /gcloud storage buckets add-iam-policy-binding/ /svc.id.goog[substratus/sci].*$/",children:"embedmd"}),":# (",(0,n.jsx)(s.a,{href:"https://raw.githubusercontent.com/substratusai/substratus/main/install/gcp/up.sh",children:"https://raw.githubusercontent.com/substratusai/substratus/main/install/gcp/up.sh"})," bash /kubectl create ns/ /$/)"]}),"\n",(0,n.jsx)(s.pre,{children:(0,n.jsx)(s.code,{className:"language-bash",children:"kubectl create ns substratus\n"})}),"\n",(0,n.jsx)(s.p,{children:"Create a ConfigMap that references the resources from step 2 to 5 by using\nthe environment variables that you set."}),"\n",(0,n.jsx)(s.p,{children:"Verify the environment variables have been set correctly:"}),"\n",(0,n.jsx)(s.pre,{children:(0,n.jsx)(s.code,{className:"language-sh",children:'echo "ARTIFACTS_BUCKET: ${ARTIFACTS_BUCKET}"\necho "REGISTRY_URL: ${REGISTRY_URL}"\necho "PRINCIPAL: ${SERVICE_ACCOUNT}"\n'})}),"\n",(0,n.jsxs)(s.p,{children:["Run the following to create the ConfigMap:\n",(0,n.jsx)(s.a,{href:"#",title:"https://raw.githubusercontent.com/substratusai/substratus/main/install/gcp/up.sh bash /gcloud storage buckets add-iam-policy-binding/ /svc.id.goog[substratus/sci].*$/",children:"embedmd"}),":# (",(0,n.jsx)(s.a,{href:"https://raw.githubusercontent.com/substratusai/substratus/main/install/gcp/up.sh",children:"https://raw.githubusercontent.com/substratusai/substratus/main/install/gcp/up.sh"})," bash /kubectl apply -f -/ /\\nEOF$/)"]}),"\n",(0,n.jsx)(s.pre,{children:(0,n.jsx)(s.code,{className:"language-bash",children:"kubectl apply -f - << EOF\napiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: system\n  namespace: substratus\ndata:\n  CLOUD: gcp\n  ARTIFACT_BUCKET_URL: ${ARTIFACTS_BUCKET}\n  REGISTRY_URL: ${REGISTRY_URL}\n  PRINCIPAL: ${SERVICE_ACCOUNT}\nEOF\n"})}),"\n",(0,n.jsxs)(s.p,{children:["Deploy the Substratus operator:\n",(0,n.jsx)(s.a,{href:"#",title:"https://raw.githubusercontent.com/substratusai/substratus/main/install/gcp/up.sh bash /gcloud storage buckets add-iam-policy-binding/ /svc.id.goog[substratus/sci].*$/",children:"embedmd"}),":# (",(0,n.jsx)(s.a,{href:"https://raw.githubusercontent.com/substratusai/substratus/main/install/gcp/up.sh",children:"https://raw.githubusercontent.com/substratusai/substratus/main/install/gcp/up.sh"})," bash /kubectl apply -f https.*manifests.yaml/ /$/)"]}),"\n",(0,n.jsx)(s.pre,{children:(0,n.jsx)(s.code,{className:"language-bash",children:"kubectl apply -f https://raw.githubusercontent.com/substratusai/substratus/main/install/gcp/manifests.yaml\n"})})]})}function d(e={}){const{wrapper:s}={...(0,a.a)(),...e.components};return s?(0,n.jsx)(s,{...e,children:(0,n.jsx)(l,{...e})}):l(e)}},1151:(e,s,t)=>{t.d(s,{Z:()=>c,a:()=>i});var n=t(7294);const a={},r=n.createContext(a);function i(e){const s=n.useContext(r);return n.useMemo((function(){return"function"==typeof e?e(s):{...s,...e}}),[s,e])}function c(e){let s;return s=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:i(e.components),n.createElement(r.Provider,{value:s},e.children)}}}]);